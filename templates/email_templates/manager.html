{% extends "base.html" %}
{% block title %}Email Templates Manager{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item active">Email Templates</span>
{% endblock %}

{% block extra_head %}
<style>
/* Clean Email Templates Layout System v3.0 */

/* Professional Grid Layout - Working Solution */
div.templates-grid,
.templates-grid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 1rem !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Responsive column counts */
@media screen and (min-width: 1200px) {
    div.templates-grid,
    .templates-grid {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

@media screen and (max-width: 1199px) and (min-width: 768px) {
    div.templates-grid,
    .templates-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

@media screen and (max-width: 767px) {
    div.templates-grid,
    .templates-grid {
        grid-template-columns: 1fr !important;
    }
}

/* Template Card */
.template-card-wrapper {
    display: flex;
    flex-direction: column;
}

.template-card {
    background: white;
    border: 1px solid #e0e6ed;
    border-radius: 8px;
    padding: 1rem;
    height: 280px;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Card Header */
.template-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.template-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    line-height: 1.3;
    flex: 1;
}

.template-badges {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
    margin-left: 0.5rem;
}

/* Badges */
.template-badge {
    display: inline-block;
    padding: 0.2em 0.4em;
    font-size: 0.65rem;
    font-weight: 500;
    line-height: 1;
    color: white;
    text-align: center;
    border-radius: 4px;
    white-space: nowrap;
}

.template-badge-success {
    background-color: #198754;
}

.template-badge-secondary {
    background-color: #6c757d;
}

.template-badge-info {
    background-color: #0dcaf0;
}

/* Card Content */
.template-meta {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.template-meta i {
    margin-right: 0.25rem;
}

.template-meta span {
    margin: 0 0.25rem;
}

.template-subject {
    font-size: 0.8rem;
    margin-bottom: 0.75rem;
    line-height: 1.3;
}

.template-subject strong {
    color: #2c3e50;
}

.template-subject span {
    display: block;
    margin-top: 0.25rem;
    color: #495057;
}

.template-preview {
    font-size: 0.75rem;
    color: #6c757d;
    line-height: 1.4;
    height: 3rem;
    overflow: hidden;
    flex: 1;
    margin-bottom: 0.75rem;
}

/* Card Footer */
.template-footer {
    margin-top: auto;
    border-top: 1px solid #e9ecef;
    padding-top: 0.75rem;
}

.template-version {
    color: #6c757d;
    font-size: 0.7rem;
    display: block;
    margin-bottom: 0.75rem;
}

/* Action Buttons */
.template-actions {
    display: flex;
    gap: 0.25rem;
}

.template-btn {
    flex: 1;
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    border: 1px solid #dee2e6;
    background: white;
    color: #495057;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.template-btn:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.template-btn-edit:hover {
    background: #e7f3ff;
    border-color: #0d6efd;
    color: #0d6efd;
}

.template-btn-preview:hover {
    background: #e7f6fd;
    border-color: #17a2b8;
    color: #17a2b8;
}

.template-btn-send:hover {
    background: #e8f5e8;
    border-color: #198754;
    color: #198754;
}

.template-btn-delete:hover {
    background: #ffeaea;
    border-color: #dc3545;
    color: #dc3545;
}

/* Accordion Styling */
.accordion-item {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
    margin-bottom: 1rem;
}

.accordion-button {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    color: #212529;
    text-align: left;
    background-color: #f8f9fa;
    border: 0;
    font-weight: 600;
}

.accordion-button:not(.collapsed) {
    color: #0c63e4;
    background-color: #e7f3ff;
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.125);
}

.accordion-body {
    padding: 1.5rem;
    background-color: white;
}

/* Container */
.container-xl {
    max-width: 1320px;
    margin-right: auto;
    margin-left: auto;
    padding-right: 0.75rem;
    padding-left: 0.75rem;
    overflow-x: hidden;
}

/* Modal z-index */
.modal {
    z-index: 1055;
}

.modal-backdrop {
    z-index: 1050;
}

/* Loading spinner */
.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg);
    }
}

/* Responsive adjustments */
@media (max-width: 767px) {
    .template-card {
        height: auto;
        min-height: 260px;
    }
    
    .template-btn {
        padding: 0.25rem 0.375rem;
        font-size: 0.7rem;
    }
    
    .accordion-body {
        padding: 1rem;
    }
}

/* Override any potential conflicts */
.templates-grid * {
    box-sizing: border-box;
}
</style>
{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-envelope-open-text text-primary me-2"></i>Email Templates Manager
        </h1>
        <div>
            <button class="btn btn-success" onclick="createDefaultTemplates()">
                <i class="fas fa-magic me-2"></i>Create Default Templates
            </button>
            <button class="btn btn-primary" onclick="showCreateModal()">
                <i class="fas fa-plus me-2"></i>New Template
            </button>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search templates..." onkeyup="filterTemplates()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="divisionFilter" onchange="filterTemplates()">
                        <option value="">All Divisions</option>
                        <option value="YZA">YZA</option>
                        <option value="YOH">YOH</option>
                        <option value="KOLLEL">KOLLEL</option>
                        <option value="Global">Global Templates</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter" onchange="filterTemplates()">
                        <option value="">All Categories</option>
                        <option value="acceptance">Acceptance Letters</option>
                        <option value="enrollment_contract">Enrollment Contracts</option>
                        <option value="financial_aid">Financial Aid</option>
                        <option value="reminder">Reminders</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Templates Accordion -->
    <div class="accordion accordion-flush" id="templatesAccordion">
        <!-- Acceptance Letters -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="acceptanceHeading">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#acceptanceCollapse" aria-expanded="true" aria-controls="acceptanceCollapse">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong>Acceptance Letters</strong>
                    <span class="badge bg-secondary ms-2">{{ template_counts.get('acceptance', 0) }}</span>
                </button>
            </h2>
            <div id="acceptanceCollapse" class="accordion-collapse collapse show" aria-labelledby="acceptanceHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div id="acceptanceTemplates">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading acceptance letter templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enrollment Contracts -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="enrollmentHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#enrollmentCollapse" aria-expanded="false" aria-controls="enrollmentCollapse">
                    <i class="fas fa-file-contract text-info me-2"></i>
                    <strong>Enrollment Contracts</strong>
                    <span class="badge bg-secondary ms-2">{{ template_counts.get('enrollment_contract', 0) }}</span>
                </button>
            </h2>
            <div id="enrollmentCollapse" class="accordion-collapse collapse" aria-labelledby="enrollmentHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div id="enrollment_contractTemplates">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading enrollment contract templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Aid -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="financialHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#financialCollapse" aria-expanded="false" aria-controls="financialCollapse">
                    <i class="fas fa-hand-holding-usd text-warning me-2"></i>
                    <strong>Financial Aid</strong>
                    <span class="badge bg-secondary ms-2">{{ template_counts.get('financial_aid', 0) }}</span>
                </button>
            </h2>
            <div id="financialCollapse" class="accordion-collapse collapse" aria-labelledby="financialHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div id="financial_aidTemplates">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading financial aid templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reminders -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="reminderHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reminderCollapse" aria-expanded="false" aria-controls="reminderCollapse">
                    <i class="fas fa-bell text-danger me-2"></i>
                    <strong>Reminders</strong>
                    <span class="badge bg-secondary ms-2">{{ template_counts.get('reminder', 0) }}</span>
                </button>
            </h2>
            <div id="reminderCollapse" class="accordion-collapse collapse" aria-labelledby="reminderHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div id="reminderTemplates">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading reminder templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="generalHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#generalCollapse" aria-expanded="false" aria-controls="generalCollapse">
                    <i class="fas fa-envelope text-primary me-2"></i>
                    <strong>General</strong>
                    <span class="badge bg-secondary ms-2">{{ template_counts.get('general', 0) }}</span>
                </button>
            </h2>
            <div id="generalCollapse" class="accordion-collapse collapse" aria-labelledby="generalHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div id="generalTemplates">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading general templates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variables Reference -->
        <div class="accordion-item mb-3 border rounded shadow-sm">
            <h2 class="accordion-header" id="variablesHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#variablesCollapse" aria-expanded="false" aria-controls="variablesCollapse">
                    <i class="fas fa-code text-secondary me-2"></i>
                    <strong>Variables Reference</strong>
                </button>
            </h2>
            <div id="variablesCollapse" class="accordion-collapse collapse" aria-labelledby="variablesHeading" data-bs-parent="#templatesAccordion">
                <div class="accordion-body">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Available Template Variables</h5>
                            <p class="text-muted">Use these variables in your email templates by wrapping them in double curly braces: {{variable_name}}</p>
                            
                            {% for category, vars in common_variables.items() %}
                            <div class="mb-4">
                                <h6 class="text-primary text-uppercase">{{ category }}</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Variable</th>
                                                <th>Description</th>
                                                <th>Example Usage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for var, desc in vars.items() %}
                                            <tr>
                                                <td><code class="text-primary">{{ '{{' }}{{ var }}{{ '}}' }}</code></td>
                                                <td>{{ desc }}</td>
                                                <td><code class="text-muted">{{ '{{' }}{{ var }}{{ '}}' }}</code></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalTitle">Create Email Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="templateForm" onsubmit="saveTemplate(event)">
                <div class="modal-body">
                    <input type="hidden" id="templateId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="templateName" class="form-label">Template Name *</label>
                                <input type="text" class="form-control" id="templateName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="templateCategory" class="form-label">Category *</label>
                                <select class="form-select" id="templateCategory" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="acceptance">Acceptance Letters</option>
                                    <option value="enrollment_contract">Enrollment Contracts</option>
                                    <option value="financial_aid">Financial Aid</option>
                                    <option value="reminder">Reminders</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="templateDivision" class="form-label">Division</label>
                                <select class="form-select" id="templateDivision" name="division">
                                    <option value="">Global (All Divisions)</option>
                                    <option value="YZA">YZA</option>
                                    <option value="YOH">YOH</option>
                                    <option value="KOLLEL">KOLLEL</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateSubject" class="form-label">Subject Template *</label>
                        <input type="text" class="form-control" id="templateSubject" name="subject" required 
                               placeholder="Welcome to {{school_name}}, {{student_name}}!">
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateBody" class="form-label">Email Body Template *</label>
                        <textarea class="form-control" id="templateBody" name="body" rows="12" required 
                                  placeholder="Dear {{student_name}},&#10;&#10;We are pleased to inform you..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pdfTemplate" class="form-label">Attach PDF Template (Optional)</label>
                                <select class="form-select" id="pdfTemplate" name="pdf_template">
                                    <option value="">No PDF attachment</option>
                                    <!-- PDF templates will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="includeSecureUpload" name="include_secure_upload">
                                    <label class="form-check-label" for="includeSecureUpload">
                                        Include Secure Upload Link
                                    </label>
                                    <div class="form-text">Automatically adds a secure upload link to the email</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="templateActive" name="is_active" checked>
                        <label class="form-check-label" for="templateActive">
                            Active Template
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-info" onclick="previewTemplate()">
                        <i class="fas fa-eye me-2"></i>Preview
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Email Template Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTemplates = [];
let currentTemplateId = null;
let currentCategory = 'acceptance';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Email Templates Manager - Accordion Version Loaded');
    
    // Load initial templates for acceptance (default open)
    loadTemplates('acceptance');
    loadPDFTemplates();
    
    // Setup accordion event listeners
    const accordionButtons = document.querySelectorAll('.accordion-button');
    accordionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = this.getAttribute('data-bs-target');
            const category = getCategoryFromTarget(target);
            
            console.log(`Accordion clicked: ${category}`);
            
            // Load templates when accordion is opened
            if (category && category !== 'variables') {
                setTimeout(() => {
                    loadTemplates(category);
                }, 100); // Small delay to ensure accordion is open
            }
        });
    });
    
    // Setup search and filter listeners
    document.getElementById('searchInput').addEventListener('input', filterTemplates);
    document.getElementById('divisionFilter').addEventListener('change', filterTemplates);
    document.getElementById('categoryFilter').addEventListener('change', filterTemplates);
});

function getCategoryFromTarget(target) {
    const targetMap = {
        '#acceptanceCollapse': 'acceptance',
        '#enrollmentCollapse': 'enrollment_contract',
        '#financialCollapse': 'financial_aid',
        '#reminderCollapse': 'reminder',
        '#generalCollapse': 'general',
        '#variablesCollapse': 'variables'
    };
    return targetMap[target];
}

function loadTemplates(category = null) {
    const url = category ? `/api/email-templates?category=${category}` : '/api/email-templates';
    console.log(`Loading templates for category: ${category}, URL: ${url}`);
    
    // Update current category
    if (category) {
        currentCategory = category;
    }
    
    fetch(url)
        .then(response => {
            console.log(`Response status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`API response:`, data);
            if (data.success) {
                currentTemplates = data.templates;
                console.log(`Found ${data.templates.length} templates for category ${category}`);
                displayTemplates(category || 'all', data.templates);
            } else {
                console.error('API error:', data.error);
                showError(category, data.error);
            }
        })
        .catch(error => {
            console.error('Error loading templates:', error);
            showError(category, error.message);
        });
}

function displayTemplates(category, templates) {
    const containerId = category === 'all' ? 'allTemplates' : `${category}Templates`;
    const container = document.getElementById(containerId);
    
    console.log(`Displaying templates for ${category}, container: ${containerId}`);
    
    if (!container) {
        console.error(`Container ${containerId} not found for category ${category}`);
        return;
    }
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-envelope-open text-muted" style="font-size: 2.5rem;"></i>
                <p class="mt-2 mb-3 text-muted">No templates found in this category.</p>
                <button class="btn btn-primary btn-sm" onclick="showCreateModal('${category}')">
                    <i class="fas fa-plus me-2"></i>Create First Template
                </button>
            </div>
        `;
        return;
    }
    
    // Use CSS Grid instead of Bootstrap grid for better control
    let html = '<div class="templates-grid">';
    templates.forEach(template => {
        const statusBadge = template.is_active 
            ? '<span class="template-badge template-badge-success">Active</span>' 
            : '<span class="template-badge template-badge-secondary">Inactive</span>';
            
        const pdfBadge = template.has_pdf 
            ? '<span class="template-badge template-badge-info"><i class="fas fa-paperclip"></i> PDF</span>' 
            : '';
        
        html += `
            <div class="template-card-wrapper">
                <div class="template-card">
                    <div class="template-card-header">
                        <h6 class="template-title" title="${template.name}">${template.name.length > 25 ? template.name.substring(0, 25) + '...' : template.name}</h6>
                        <div class="template-badges">
                            ${statusBadge}
                            ${pdfBadge}
                        </div>
                    </div>
                    <div class="template-meta">
                        <i class="fas fa-folder"></i>${template.category.replace('_', ' ')} 
                        <span>•</span>
                        <i class="fas fa-building"></i>${template.division || 'Global'}
                    </div>
                    <div class="template-subject">
                        <strong>Subject:</strong> 
                        <span title="${template.subject}">
                            ${template.subject.length > 40 ? template.subject.substring(0, 40) + '...' : template.subject}
                        </span>
                    </div>
                    <div class="template-preview">
                        ${template.body_preview ? template.body_preview.substring(0, 80) + (template.body_preview.length > 80 ? '...' : '') : 'No preview available'}
                    </div>
                    <div class="template-footer">
                        <small class="template-version">v${template.version || 1} • ${formatDate(template.updated_at)}</small>
                        <div class="template-actions">
                            <button type="button" class="template-btn template-btn-edit" onclick="editTemplate(${template.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="template-btn template-btn-preview" onclick="showPreview(${template.id})" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="template-btn template-btn-send" onclick="sendTestEmail(${template.id})" title="Send Test">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button type="button" class="template-btn template-btn-delete" onclick="deleteTemplate(${template.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
    console.log(`Templates displayed successfully for ${category}`);
}

function showError(category, errorMessage) {
    const containerId = category ? `${category}Templates` : 'allTemplates';
    const container = document.getElementById(containerId);
    
    if (container) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Templates</h6>
                <p class="mb-0">${errorMessage}</p>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadTemplates('${category}')">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        `;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: '2-digit'
    });
}

function filterTemplates() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const division = document.getElementById('divisionFilter').value;
    const category = document.getElementById('categoryFilter').value;
    
    let filtered = currentTemplates;
    
    if (search) {
        filtered = filtered.filter(t => 
            t.name.toLowerCase().includes(search) || 
            t.subject.toLowerCase().includes(search) ||
            (t.body_preview && t.body_preview.toLowerCase().includes(search))
        );
    }
    
    if (division) {
        filtered = filtered.filter(t => 
            (division === 'Global' && !t.division) || 
            t.division === division
        );
    }
    
    if (category) {
        filtered = filtered.filter(t => t.category === category);
        // If filtering by category, display in that category
        displayTemplates(category, filtered);
    } else {
        // Display filtered results in the current category
        displayTemplates(currentCategory, filtered);
    }
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('divisionFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    
    // Reload current category templates
    loadTemplates(currentCategory);
}

function showCreateModal(category = null) {
    document.getElementById('templateModalTitle').textContent = 'Create Email Template';
    document.getElementById('templateForm').reset();
    document.getElementById('templateId').value = '';
    
    if (category && category !== 'all') {
        document.getElementById('templateCategory').value = category;
    }
    
    new bootstrap.Modal(document.getElementById('templateModal')).show();
}

function editTemplate(templateId) {
    fetch(`/api/email-templates/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const template = data.template;
                document.getElementById('templateModalTitle').textContent = 'Edit Email Template';
                document.getElementById('templateId').value = template.id;
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateCategory').value = template.category;
                document.getElementById('templateDivision').value = template.division || '';
                document.getElementById('templateSubject').value = template.subject_template;
                document.getElementById('templateBody').value = template.body_template;
                document.getElementById('templateActive').checked = template.is_active;
                
                if (template.pdf_template_name) {
                    document.getElementById('pdfTemplate').value = template.pdf_template_name;
                }
                
                new bootstrap.Modal(document.getElementById('templateModal')).show();
            }
        })
        .catch(error => {
            console.error('Error loading template:', error);
            alert('Error loading template for editing');
        });
}

function saveTemplate(event) {
    event.preventDefault();
    
    const form = document.getElementById('templateForm');
    const formData = new FormData(form);
    const templateData = Object.fromEntries(formData.entries());
    
    // Handle checkbox
    templateData.is_active = document.getElementById('templateActive').checked;
    templateData.include_secure_upload = document.getElementById('includeSecureUpload').checked;
    
    const templateId = document.getElementById('templateId').value;
    const isEdit = templateId && templateId !== '';
    
    const url = isEdit ? `/api/email-templates/${templateId}` : '/api/email-templates';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(templateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
            
            // Reload the appropriate category
            const category = templateData.category;
            loadTemplates(category);
            
            alert(isEdit ? 'Template updated successfully!' : 'Template created successfully!');
        } else {
            alert('Error saving template: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving template:', error);
        alert('Error saving template. Please try again.');
    });
}

function deleteTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/email-templates/${templateId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Template deleted successfully!');
            // Reload the current category
            loadTemplates(currentCategory);
        } else {
            alert('Error deleting template: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting template:', error);
        alert('Error deleting template. Please try again.');
    });
}

function showPreview(templateId) {
    // Show loading state
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `;
    
    // Show the preview modal
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
    
    // Fetch the preview from the backend
    fetch('/api/email-templates/' + templateId + '/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const preview = data.preview;
            previewContent.innerHTML = `
                <div class="mb-3">
                    <h6><i class="fas fa-envelope me-2"></i>Subject:</h6>
                    <div class="border rounded p-2 bg-light">
                        ${preview.subject}
                    </div>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-file-text me-2"></i>Email Body:</h6>
                    <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        ${preview.body}
                    </div>
                </div>
                <div class="small text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    This preview uses sample data. Actual emails will use real student information.
                </div>
            `;
        } else {
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading preview: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading preview:', error);
        previewContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading preview. Please try again.
            </div>
        `;
    });
}

function sendTestEmail(templateId) {
    // Prompt for email address
    const testEmail = prompt('Enter email address to send test to:', '');
    if (!testEmail) {
        return; // User cancelled
    }
    
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    button.disabled = true;
    
    // Send test email
    fetch('/api/email-templates/' + templateId + '/send-test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Test email sent successfully to ' + testEmail + '!');
        } else {
            alert('❌ Error sending test email: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending test email:', error);
        alert('❌ Error sending test email. Please try again.');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function previewTemplate() {
    // Get current template data from the form
    const templateId = document.getElementById('templateId').value;
    const subjectTemplate = document.getElementById('templateSubject').value;
    const bodyTemplate = document.getElementById('templateBody').value;
    const division = document.getElementById('templateDivision').value;
    
    if (!subjectTemplate || !bodyTemplate) {
        alert('Please fill in both subject and body templates before previewing.');
        return;
    }
    
    // Create a temporary template object for preview
    const tempTemplate = {
        subject_template: subjectTemplate,
        body_template: bodyTemplate,
        division: division || 'YZA'
    };
    
    // Show loading state
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Generating preview...</p>
        </div>
    `;
    
    // Show the preview modal
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
    
    // Generate preview using sample data
    const sampleContext = {
        'student_name': 'John Doe',
        'student_first_name': 'John',
        'student_last_name': 'Doe',
        'student_email': 'john.doe@example.com',
        'student_phone': '(555) 123-4567',
        'student_division': division || 'YZA',
        'student_id': '12345',
        'hebrew_name': 'יוחנן בן יעקב',
        'date_of_birth': 'January 1, 2000',
        'father_title': 'Mr.',
        'father_name': 'James Doe',
        'father_email': 'james.doe@example.com',
        'mother_title': 'Mrs.',
        'mother_name': 'Jane Doe',
        'mother_email': 'jane.doe@example.com',
        'academic_year': '2024-2025',
        'current_date': new Date().toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        }),
        'school_name': division === 'YZA' ? 'Yeshiva Zichron Aryeh' : 'Yeshiva Ohr Hatzafon',
        'tuition_amount': '$4,260',
        'secure_upload_link': 'https://portal.school.edu/secure/upload/abc123',
        'opensign_link': 'https://opensign.school.edu/sign/xyz789'
    };
    
    // Simple template rendering (basic variable substitution)
    let renderedSubject = subjectTemplate;
    let renderedBody = bodyTemplate;
    
    // Replace variables in subject and body
    Object.keys(sampleContext).forEach(key => {
        const placeholder = '{{' + key + '}}';
        const value = sampleContext[key];
        renderedSubject = renderedSubject.replace(new RegExp(placeholder, 'g'), value);
        renderedBody = renderedBody.replace(new RegExp(placeholder, 'g'), value);
    });
    
    // Display the preview
    previewContent.innerHTML = `
        <div class="mb-3">
            <h6><i class="fas fa-envelope me-2"></i>Subject:</h6>
            <div class="border rounded p-2 bg-light">
                ${renderedSubject}
            </div>
        </div>
        <div class="mb-3">
            <h6><i class="fas fa-file-text me-2"></i>Email Body:</h6>
            <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                ${renderedBody}
            </div>
        </div>
        <div class="small text-muted">
            <i class="fas fa-info-circle me-1"></i>
            This preview uses sample data. Actual emails will use real student information.
        </div>
    `;
}

function loadPDFTemplates() {
    // Implementation for loading PDF templates
    console.log('Loading PDF templates');
}

function createDefaultTemplates() {
    if (!confirm('This will create default email templates for all divisions. Continue?')) {
        return;
    }
    
    fetch('/api/email-templates/create-defaults', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Default templates created successfully!');
            loadTemplates(currentCategory); // Reload current category
        } else {
            alert('Error creating default templates: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating default templates:', error);
        alert('Error creating default templates. Please try again.');
    });
}
</script>
{% endblock %}
